# Создание клиент-серверной модели данных для обмена данными между клиентами, написанными на FLUTTER и сервером NET5

[license](https://github.com/dart-lang/stagehand/blob/master/LICENSE)


## Порядок действий для генерации модели обмена данных

1.	Непосредственно генерацию осуществляет данный проект (nsg_generator https://github.com/zenalex/nsg_generator.git)
2.	Создайте или подготовьте следующие проекты: Flutter  - для генерации клиента, NET5 – для генерации сервера
3.	В проекте Flutter создаем папку сonfig (название любое) вне папки lib (для того, чтобы файлы в ней не были включены в конечный проект). В этой папке (будем называеть её config) будем создавать файлы-описатели классов и вызываемых функций в формате json

## Создание конфигурационных файлов

Все данные файлы создаются в папке config и имеют формат json.
generation_config.json - Основной файл, содержащий описание всех генерируемых типов данных.

#

### 1. Описание структуры generation_config:

Версия .NET, под которую будет создана серверная часть (поддерживаются net5 и net472, по умолчанию net5)  
```json
"targetFramework": "net5",
```  

Путь к папке проекта .NET для генерации классов 
```json
"cSharpPath": "X:/Path/",
```

.NET namespace для генерации классов  
```json
"cSharpNamespace": "namespace",
```

Путь к папке проекта FLUTTER для генерации классов  
```json
"dartPath": "X:/Path"
```

Массив генерируемых контроллеров  
```json
"controller": []
```

Массив генерируемых перечислений  
```json
"enums": []
```

#

### 1. 1. Описание структуры контроллеров controller

Префикс для вызова web-api  
```json
"api_prefix": "Api",
```

Имя класса контроллера  
```json
"class_name": "DataController",
```

Имя класса, содержащего реализации функций контроллера  
```json
"impl_controller_name": "DataControllerImplementation",
```

Имя класса, реализующего функции аутентификации  
```json
"impl_auth_controller_name": "AuthControllerImplementation",
```

Использует ли контроллер проверку пользователей  
```json
"useAuthorization": "true",
```

Тип контроллера (пока единственный из доступных)  
```json
"dataType": "NsgDataItem",
```

Uri сервера  
```json
"serverUri": "http://server.name:5000",
```

Массив классов данных  
```json
"method": []
```

#

### 1. 1. 1. Описание структуры классов данных (method)

Имя класса данных  
```json
"name": "UserData",
```

Описание класса данных для чтения человеком  
```json
"description" : "Get user data",
```

Префикс web-api для запроса операций чтения и записи с данным классом  
```json
"api_prefix": "UserData",
```

Уровень прав, требуемый для обращения к данным:  
- anonymous
- user

```json
"authorize": "user",
```

Тип HTTP-запроса на чтение (GET или POST)  
```json
"getterType": "get",
```

Имя файла описания структуры полей данного класса  
```json
"dataTypeFile": "userItem.json",
```

Генерировать метод для чтения (по умолчанию true)  
```json
"allowGetter": "false"
```

Генерировать метод для записи  
```json
"allowPost": "true"
```

Перед записью проверять время предыдущей записи данного объекта.  
Если за время редактирования объект был записан параллельно, запись будет отменена, сервер вернет ошибку.  
Дата предыдущей записи должна храниться в самом объекте.  
```json
"checkLastModifiedDate": "true"
```

Генерировать метод для удаления  
```json
"allowDelete": "true"
```

Функции  
```json
"functions": []
```

#

>###### *1.
>Поле referenceType нужно заполнять, если type
>- ссылочный (```"type": "Reference"```)
>- список объектов (```"type": "List<Reference>"```)
>- перечисление (```"type": "Enum"```)

#

### 1. 1. 2. Описание структуры функции (function)

Имя функции  
```json
"name": "UserData",
```

Тип выходных данных функции  
```json
"type": "int",
```

Если тип - генерируемый объект, необходимо указать тип генерируемого объекта ([*1](#1))  
```json
"referenceType": "DayOfWeek",
```

Уровень прав, требуемый для обращения к функции:  
- anonymous
- user

```json
"authorize": "user",
```

Префикс для вызова web-api  
```json
"api_prefix": "Api",
```

Описание функции для чтения человеком  
```json
"description" : "Get user data",
```

Входные параметры функции  
```json
"params": []
```

#

### 1. 1. 2. 1. Описание структуры входных параметров функции (params)

Имя параметра  
```json
"name": "UserData",
```

Тип данных параметра  
```json
"type": "int",
```

Если тип - генерируемый объект, необходимо указать тип генерируемого объекта ([*1](#1))  
```json
"referenceType": "DayOfWeek",
```

Массив генерируемых перечислений  
```json
"enums": []
```

#

### 1. 2. Описание структуры перечисления (enum)  

Имя класса перечисления  
```json
"class_name": "DaysOfWeek",
```

Описание перечисления для чтения человеком  
```json
"description": "Дни недели",
```

Имя файла описания структуры полей данного перечисления  
```json
"dataTypeFile": "days_of_week.json"
```

#

### 2. Файл описания структуры объекта

Имя типа генерируемого объекта  
```json
"typeName": "TeamItem",
```

Описание поля для чтения человеком  
```json
"description" : "Some item",
```

Имя типа объекта метаданных (при наличии)  
```json
"databaseType": "Команды",
```

.NET namespace объекта метаданных (при наличии)  
```json
"databaseTypeNamespace": "TechControl.Метаданные.Мониторинг",
```

Перегрузка методов ToString()  
```json
"presentation": "name",
```

Максимальное число объектов, возвращаемое сервером (не больше 100)  
```json
"maxHttpGetItems": 100,
```

Поля объекта  
```json
"fields": []
```

#

### 2. 1. Описание структуры полей объекта (fields)

Имя поля  
```json
"name": "Id",
```

Тип поля  
```json
"type": "String",
```

Имя поля в объекте метаданных (при наличии)  
```json
"databaseName": "Идентификатор",
```

Тип поля в объекте метаданных (при наличии)  
```json
"databaseType": "ДеньНедели",
```

Макс. длина строки или значение числа  
```json
"maxLength": 50,
```

Описание поля для чтения человеком  
```json
"description" : "Some value",
```

Если тип поля Image (изображение), для его получения нужен префикс api  
```json
"api_prefix": "pic0"
```

Признак ключевого поля  
```json
"isPrimary": "true"
```

Если тип - генерируемый объект, можно указать имя ссылки для Flutter ([*1](#1))  
```json
"referenceName": "Position",
```

Если тип - генерируемый объект, необходимо указать тип генерируемого объекта ([*1](#1))  
```json
"referenceType": "TeamItemMembersTable",
```

Можно указывать человекочитаемые имена полей  
```json
"userVisibility": "true",
"userName": "The Field!"
```

#

### 3. Файл описания структуры перечисления  

Список возможных значений  
```json
"values": []
```

#

### 3. 1. Описание структуры значения перечисления

Имя для кода  
```json
"codeName": "Unknown",
```

Имя для человека  
```json
"name": "Неизвестно",
```

Числовой индекс  
```json
"value": "0"
```

#

## Запуск
Генерацию можно запустить прямо из консоли PowerShell:
```
dart bin\nsgCodeGenerator.dart C:\GeneratorConfig [-csharp] [-dart] [-force|-overwrite|-forceoverwrite] [csharp:] [dart:]
```
### Аргументы командной строки:
- Генерировать только C# (если не указано также `-dart`)
```
-csharp
```
- Генерировать только Dart (если не указано также `-csharp`)
```
-dart
```
- Принудительная перезапись (без этого аргумента при повторной генерации некоторые файлы не перезаписываются)
```
-force
-overwrite
-forceoverwrite
```
- Указать путь для генерации проекта C# (вместо указанного в [generation_config.json](#1-описание-структуры-generation_config))
```
csharp:C:\Server
```
- Указать путь для генерации файлов Dart (вместо указанного в [generation_config.json](#1-описание-структуры-generation_config))
```
dart:C:\Client\lib
```
